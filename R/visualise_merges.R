#' @export
add_dad_birthyear <- function(x) {
  z <- x %>% 
    left_join(x %>% select(pid, birthyear), 
              by = c("pid_dad" = "pid"), 
              suffix = c("", "_dad"))
  
  return(z)
}

#' @export
add_dad_is_surrogate <- function(x) {
  z <- x %>% 
    left_join(x %>% select(pid, is_surrogate), 
              by = c("pid_dad" = "pid"), 
              suffix = c("", "_dad"))
  
  return(z)
}


#' @export
insert_missing_pids <- function(d) {
  d <- d %>% mutate(sex = "male", 
                    pid_mom = NA,
                    status = 0) 
  # Slow, ok for now
  
  #d <- d_tmp %>% arrange(pid)
  
  #next_pid <- 1L + max(d$pid, d$pid_dad, d$pid_mom, na.rm = TRUE)
  new_persons <- list()
  
  for (i in 1L:nrow(d)) {

    if (!is.na(d$pid_dad[i]) && !(d$pid_dad[i] %in% d$pid)) {
      new_persons[[length(new_persons) + 1L]] <- tibble(
        pid = d$pid_dad[i],
        pid_dad = NA,
        pid_mom = NA,
        sex = "male",
        status = 0)
    }
    
    if (!is.na(d$pid_mom[i]) && !(d$pid_mom[i] %in% d$pid)) {
      new_persons[[length(new_persons) + 1L]] <- tibble(
        pid = d$pid_mom[i], 
        pid_dad = NA,
        pid_mom = NA,
        sex = "female",
        status = 0)
    }
    
    # Now, non-NA parents exists, but NA's don't and kinship2
    # forces either both or no parents
    if (is.na(d$pid_mom[i]) && !is.na(d$pid_dad[i])) {
      
      # FIXME: Stupid, but probably okay
      new_pid_mom <- 1L
      while (new_pid_mom %in% d$pid || new_pid_mom %in% d$pid_mom || new_pid_mom %in% d$pid_dad) {
        new_pid_mom <- new_pid_mom + 1L
      }
      
      d$pid_mom[i] <- new_pid_mom
      new_persons[[length(new_persons) + 1L]] <- tibble(
        pid = new_pid_mom, 
        pid_dad = NA,
        pid_mom = NA,
        sex = "female",
        status = 0)
        #status = 1)
    }
    if (!is.na(d$pid_mom[i]) && is.na(d$pid_dad[i])) {
      
      # FIXME: Stupid, but probably okay
      new_pid_dad <- 1L
      while (new_pid_dad %in% d$pid || new_pid_dad %in% d$pid_mom || new_pid_dad %in% d$pid_dad) {
        new_pid_dad <- new_pid_dad + 1L
      }
      
      d$pid_dad[i] <- new_pid_dad
      new_persons[[length(new_persons) + 1L]] <- tibble(
        pid = new_pid_dad, 
        pid_dad = NA,
        pid_mom = NA,
        sex = "male",
        status = 0)
        #status = 1)
    }
  }
  
  d_new_persons <- bind_rows(new_persons) %>% 
    distinct()
  
  d <- bind_rows(d, d_new_persons)
  return(d)
}




#' @importFrom kinship2 pedigree plot.pedigree
#' @export
visualise_merges <- function(res, highlight_pids1 = c(), highlight_pids2 = c(), cex = 0.5, ...) {
  ped_raw <- res %>% 
    insert_missing_pids()
  
  label <- ped_raw %>% 
    mutate(pid_chr = ifelse(is.na(birthyear), 
                            paste0("(", pid, ")"),
                            paste0(birthyear, "\n", "(", pid, ")",
                                   ifelse(is_surrogate, "\nSURR", "")))) %>% 
    pull(pid_chr)
  
  clr <- ped_raw %>% 
    mutate(clr = case_when(
      length(highlight_pids1) > 0 & pid %in% highlight_pids1 ~ "red",
      length(highlight_pids2) > 0 & pid %in% highlight_pids2 ~ "yellow",
      sex == "female" ~ "lightgrey",
      is_surrogate ~ "blue",
      TRUE ~ "black")) %>% 
    pull(clr)
  
  ped <- with(ped_raw, kinship2::pedigree(
    id = pid, 
    dadid = pid_dad, 
    momid = pid_mom, 
    sex = sex,
    status = status))

  p <- kinship2::plot.pedigree(ped, id = label, col = clr, cex = cex, ...)
  
  return(invisible(p))
}


#' @importFrom igraph graph_from_data_frame
#' @importFrom tidygraph as_tbl_graph activate
#' @importFrom dplyr left_join
#' @importFrom ggplot2 ggraph scale_x_continuous scale_y_reverse theme
#' @importFrom ggraph ggraph geom_edge_diagonal geom_node_point
#' 
#' @export
ggcopape <- function(d) {
  
  d_tmp <- d %>% 
    select(pid, pid_dad) %>% 
    left_join(d %>% select(pid), 
              by = c("pid_dad" = "pid"), 
              suffix = c("_son", "_dad")) %>% 
    rename(pid_son = pid) %>% 
    filter(complete.cases(.)) %>% 
    select(2, 1)

  graph <- igraph::graph_from_data_frame(d_tmp, directed = TRUE)
  
  g <- tidygraph::as_tbl_graph(graph)
  
  g2 <- g %>% 
    tidygraph::activate(nodes) %>% 
    dplyr::left_join(d %>% mutate(pid = as.character(pid)), by = c("name" = "pid")) %>% 
    mutate(org_paternalped_id = as.character(org_paternalped_id)) %>% 
    mutate(org_paternalped_id = case_when(
      is.na(org_paternalped_id) ~ "NA",
      TRUE ~ org_paternalped_id
    ))
  
  # Create layout
  ll <- ggraph::create_layout(g2, layout = 'dendrogram', 
                              circular = FALSE)
  ll2 <- ll
  ll_nms <- as.integer(as.character(ll2$name))
  ll_df <- tibble(pid = ll_nms) %>% 
    inner_join(d, by = c("pid"))
  
  
  stopifnot(isTRUE(all.equal(ll_df %>% pull(pid), ll_nms)))
  ll2$y <- ll_df %>% pull(birthyear)
  
  
  
  p <- ggraph::ggraph(ll2) + 
    ggraph::geom_edge_diagonal() +
    ggraph::geom_node_point(aes(color = org_paternalped_id,
                        shape = is_surrogate,
                        size = is_surrogate), 
                    show.legend = FALSE) +
    ggplot2::scale_x_continuous(breaks = NULL) +
    ggplot2::scale_y_reverse(breaks = scales::pretty_breaks(10)) +
    ggplot2::theme(
      #axis.line = element_blank(),
      axis.text.x = element_blank(),
      #axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.position = "none",
      panel.background = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_line(size = 0.1, 
                                      colour = 'darkgrey'),
      panel.grid.minor = element_line(size = 0.1, 
                                      colour = 'darkgrey'),
      plot.background = element_blank()) 
  
  return(p)
}

